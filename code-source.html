<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code source</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            font-family: Segoe UI, sans-serif;
            background: linear-gradient(135deg, #9854C7 0%, #FFA07A 100%);
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            text-align: center;
            padding: 2rem 0;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: white;
        }

        .header p {
            font-size: 1.2rem;
            margin-top: 0.5rem;
        }

        .main-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2rem;
            margin: 2rem 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        img {
            width: 45%;
            margin: 1rem;
            border-radius: 10px;
        }

        h2 {
            font-size: 2rem;
            margin-top: 1.5rem;
        }

        p {
            font-size: 1.2rem;
            line-height: 1.8;
        }

        ul {
            margin: 1rem 0;
            padding-left: 2rem;
        }

        footer {
            text-align: center;
            padding: 1rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .block {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .block h2 {
            color: white;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
  <div class="container">
        <header class="header">
            <h1>Code source</h1>
        </header>

        <main>
            <section class="section block">
                <h2>smams_brevet.R</h2>
                <p>
                    <br>#
<br># Simon Fraile, Matilin Periat, Ahina Durrieu, Maina Boivent, Sébastien Hein
<br># 
<br># File smams_brevet.R
<br>#  
<br># Creation of the base_brevets database
<br>#
<br># Required files in the DATA folder:
<br># - 202202_EPO_App_reg_small.txt
<br># - 202202_EPO_IPC_small.txt
<br># - EN_ipc_section_A_title_list_20120101.txt
<br># - EN_ipc_section_B_title_list_20120101.txt
<br># - EN_ipc_section_C_title_list_20120101.txt
<br># - EN_ipc_section_D_title_list_20120101.txt
<br># - EN_ipc_section_E_title_list_20120101.txt
<br># - EN_ipc_section_F_title_list_20120101.txt
<br># - EN_ipc_section_G_title_list_20120101.txt
<br># - EN_ipc_section_H_title_list_20120101.txt
<br>#
<br>#
<br>###########################
<br>### Importing libraries ###
<br>###########################
<br>source("smams_src_utilities.R")
<br>library(data.table)
<br>library(stringr)
<br># _________________________________________________________________________________________________________________________________
<br>######################
<br>### Importing data ###
<br>######################
<br>brevets = data.table(read.csv(file = "DATA/202202_EPO_App_reg_small.txt",head = TRUE, sep = ","))
<br>ipc = data.table(read.csv(file = "DATA/202202_EPO_IPC_small.txt", head = TRUE, sep = ","))
<br># Remove unnecessary columns
<br>brevets[, c("app_nbr", "pub_nbr", "person_id", "address", "reg_code", "reg_share", "app_share") := NULL]
<br>ipc[, app_year := NULL]
<br># Format postal codes to department numbers
<br>brevets[, postal_code := as.integer(substr(postal_code, 1, 2))]
<br># _________________________________________________________________________________________________________________________________
<br>######################
<br>### Data filtering ###
<br>######################
<br># 1st filter: Keep only French companies
<br>brevets = brevets[ctry_code == "FR"]
<br># Same for ipc data
<br>ipc = ipc[appln_id %in% brevets[, appln_id]]  
<br># Remove the ctry_code column
<br>brevets[, ctry_code := NULL]
<br># 2nd filter: Keep only patents filed between 2010 and 2020
<br>ipc = ipc[prio_year >= 2010 & prio_year <= 2020]
<br># Same for patents
<br>brevets = brevets[appln_id %in% ipc[, appln_id]]
<br># No longer need the prio_year variable
<br>ipc[, prio_year := NULL]

# 3rd filter: Keep only the first 4 characters of ipc
ipc$IPC = substr(ipc$IPC, 1, 4)

# _________________________________________________________________________________________________________________________________
#########################
### Name modification ###
#########################
#
# Create the firm_name column containing the company name,
# and id_firm_name to group companies together
# For example, 'Peugeot' and 'Peugeot SA' are the same company. In id_firm_name, the value will be 'peugeot' for both.
brevets$firm_name = brevets$app_name
# Keep only the first word, in lowercase, remove accents, commas, and other symbols
brevets$id_firm_name = gsub(',','',iconv(tolower(word(brevets$app_name,1)), to = "ASCII//TRANSLIT"))
brevets[, app_name := NULL]

# _________________________________________________________________________________________________________________________________
#############################
### Creating base_brevets ###
#############################

# Merge the two data tables
base_brevets = merge(brevets, ipc, by='appln_id')
# Initialize the number of patents to 1
base_brevets[, n_patents := 1]

#___________________________________________________________________________________________________________________________________
##################
### Adding ipc ###
##################

# Add ipc_main_code and ipc_second_code columns
base_brevets[, c("ipc_main_code", "ipc_second_code") := {
  top_ipc <- find_top_ipc(IPC)
  list(top_ipc[1], ifelse(length(top_ipc) > 1, top_ipc[2], NA))
}, by = id_firm_name]

base_brevets[, IPC := NULL]

#___________________________________________________________________________________________________________________________________
###################
### Aggregation ###
###################

# Aggregate by id_firm_name to consider that company names like 'Peugeot SA' and 'peugeot'
# describe the same companies
base_brevets = base_brevets[, .(
  firm_name = first(firm_name),
  n_patents = sum(n_patents),
  ipc_main_code = first(ipc_main_code),
  ipc_second_code = first(ipc_second_code),
  addr_city_main = first(city),
  addr_dept_main = first(postal_code)
), by = id_firm_name]

# No longer need id_firm_name
base_brevets[, id_firm_name := NULL]

#___________________________________________________________________________________________________________________________________
###############################
### Adding ipc descriptions ###
###############################

# Names of ipc description files
lettres = LETTERS[1:8] # vector with A,B,..,H
fichiers = paste0("DATA/EN_ipc_section_", lettres, "_title_list_20120101.txt") # IPC descriptions

# Import files
desc_separe = lapply(fichiers, function(f){
  data.table(read.csv(file = f, head = TRUE, sep = "\t"))
})
names(desc_separe) = LETTERS[1:8]

# Determine ipc_main_desc. Need to:
# - isolate the first letter of each ipc code,
# - look up the associated description in desc_separe$'X',
# - add it to the ipc_main_desc variable.
#
# Do the same for ipc_second_desc

# Extract the first letter of each ipc_main_code
base_brevets[, first_letter_main := substr(ipc_main_code, 1, 1)]
base_brevets[, first_letter_second := substr(ipc_second_code, 1, 1)]

# For each first letter, join with the corresponding data table
for (letter in LETTERS[1:8]) {
  # Get the name of the second column
  desc_col = names(desc_separe[[letter]])[2]
  
  base_brevets[first_letter_main == letter, 
               ipc_main_desc := desc_separe[[letter]][.(ipc_main_code), get(desc_col), on=letter]]
  base_brevets[first_letter_second == letter, 
               ipc_second_desc := desc_separe[[letter]][.(ipc_second_code), get(desc_col), on=letter]]
}

# Remove the temporary first_letter column
base_brevets[, c('first_letter_main', 'first_letter_second') := NULL]


#___________________________________________________________________________________________________________________________________
###################################
### Writing the database to csv ###
###################################

fwrite(base_brevets, "DATA/base_brevets.csv") 

#___________________________________________________________________________________________________________________________________
###########
### END ###
###########
                </p>

            </section>

        </main>

        <footer>
            © 2024 - Code source
        </footer>
    </div>
</body>
</html>
            
